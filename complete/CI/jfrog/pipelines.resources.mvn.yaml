resources:

# mvn PIPELINE
  - name: src_code_backapp_mvn
    type: GitRepo
    configuration:
      files:
        include: ^complete\/.+
        exclude: ^complete\/CI\/.+
      gitProvider: yann_github
      path: cyan21/gs-multi-module
      branches:
        include: jfrog

# DOCKER PIPELINE
  - name: src_dockerfile_backapp_mvn
    type: GitRepo
    configuration:
      files:
        include: ^complete\/CI\/Docker\/Dockerfile      
      gitProvider: yann_github
      path: cyan21/gs-multi-module
      branches:
        include: jfrog

  # Build info for the published mvn App
  - name: bi_backapp_mvn
    type: BuildInfo
    configuration:
      sourceArtifactory: artifactory_eu
      buildName: backapp_mvn
      buildNumber: ${run_number}

  - name: bi_backapp_mvn_promoted_staging
    type: BuildInfo
    configuration:
      sourceArtifactory: artifactory_eu
      buildName: backapp_mvn
      buildNumber: '${run_number}'

  - name: pb_backapp_mvn
    type: PropertyBag
    configuration:
      biNumber: XXX

  - name: fs_backapp_mvn
    type: FileSpec
    configuration:
      sourceArtifactory: artifactory_eu
      pattern: "${mvnPromoteRepo}/**/multi-module-application*.jar"
      target: app/multi-module-application-1.0.0.jar
      # props: "build.name=backapp_mvn;build.number=${res_pb_backapp_mvn_biNumber}"
      props: "build.name=backapp_mvn;build.number=${biNumber}"
      flat: true

  - name: bi_backapp_mvn_docker
    type: BuildInfo
    configuration:
      sourceArtifactory: artifactory_eu
      buildName: backapp_mvn_docker
      buildNumber: '${run_number}'

  - name: bi_backapp_mvn_docker_promoted_staging
    type: BuildInfo
    configuration:
      sourceArtifactory: artifactory_eu
      buildName: backapp_mvn_docker
      buildNumber: '${run_number}'


###### DISTRIBUTION

  - name: distribution_mvn
    type: GitRepo
    configuration:
      gitProvider: yann_github
      path: cyan21/distribution-pipelines
      branches:
        include: master

  - name: bi_mvn_debian
    type: BuildInfo
    configuration:
      sourceArtifactory: artifactory_eu
      buildName: webapp-debian
      buildNumber: 1

  - name: rb_mvn_debian
    type: ReleaseBundle
    configuration:
      sourceDistribution: distribution_eu
      name: java-webapp
      version: "1"          # will be overriden by the CreateReleaseBundle step 
      isSigned: true

  - name: aql_distrib_debian
    type: Aql
    configuration:
      sourceArtifactory: artifactory_eu
      query: > 
        items.find({
        "$and": [
        {"@app.version": "${appVersion}"},
        {"@app.name": "ninja"}
        ]})
      addedProperties:
        distribution: "automatic"
      mappings:
        - name: java
          input: "ninja-rc-mvn-local/(.*)"
          output: "ninja-mvn-release-local/$1"
        - name: debian
          input: "ninja-release-debian-local/pool/(.*)"
          output: "ninja-debian-release-local/pool/$1"

  - name: dr_mvn_debian 
    type: DistributionRule
    configuration:
      sourceDistribution: distribution_eu
      serviceName: "*"         
      siteName: "*"
      cityName: "New York City"
      countryCodes:
        - "US"